# DesktopBeatLight 项目记录文档

## 项目概述
DesktopBeatLight 是一款基于 .NET 8 开发的 Windows 桌面音频可视化工具，通过捕获系统音频、进行 FFT 分析，在桌面边缘生成实时响应的动态灯带效果。

## 项目结构
项目采用三层架构设计：

```
├── DesktopBeatLight.Audio   # 音频层
│   ├── Abstractions\        # 音频相关接口
│   ├── Implementations\     # 音频实现（NAudio封装）
│   ├── Helpers\             # 音频处理辅助类
│   └── Models\              # 音频数据模型
│
├── DesktopBeatLight.Core    # 核心层
│   ├── Abstractions\        # 核心功能接口
│   ├── Constants\           # 常量定义
│   ├── Data\                # 数据访问层
│   ├── IMplementations\     # 核心功能实现
│   │   ├── FftAnalyzer.cs
│   │   ├── ThemeConfigRepository.cs
│   │   └── ThemeRenderers\  # 主题渲染器实现
│   │       ├── FireThemeRenderer.cs
│   │       ├── OceanThemeRenderer.cs
│   │       └── NeonThemeRenderer.cs
│   ├── Models\              # 核心数据模型
│   └── SignalProcessing\    # 信号处理相关（FFT等）
│
└── DesktopBeatLight.UI      # 表现层
    ├── Controllers\         # UI控制器
    ├── Program.cs           # 程序入口
    ├── Form1.cs             # 主窗口
    └── Properties\          # 项目属性
```

## 已实现功能

### 1. 音频捕获模块
- **WasapiAudioCapture**：已完整实现基于NAudio库的系统音频环回捕获
- **SilenceDetector**：已实现静音检测（RMS音量检测，≤-40dB判定为静音）
- 已实现静音持续2秒后自动标记为静音状态
- 已实现音频数据转换为单声道浮点数据的功能

### 2. 频谱分析模块
- **FftAnalyzer**：已完整实现基于MathNet.Numerics库的FFT频谱分析器
- 已实现时域音频数据转换为频域幅度谱的功能
- 已实现512点FFT到64点降采样的处理流程
- 已实现频谱平滑处理算法

### 3. 主题渲染系统
- **三种主题渲染器**：已完整实现
  - **FireThemeRenderer**：火焰主题，温暖的橙红色调，模拟火焰跳动效果
  - **OceanThemeRenderer**：海洋主题，清凉的蓝绿色调，包含海浪和泡沫效果
  - **NeonThemeRenderer**：霓虹灯主题，鲜艳的霓虹色调，包含发光和闪烁效果
- **IThemeRenderer接口**：已定义统一的主题渲染接口
- 已实现主题切换逻辑（工厂模式）
- 已实现基于频谱数据的动态渲染

### 4. 数据模型
- **ThemeConfig**：已完整定义主题配置模型，包含颜色、尺寸、位置等属性
- 已添加数据注解用于数据库映射
- 已实现构造函数和属性访问器

### 5. 数据访问
- **AppDbContext**：已实现Entity Framework Core数据库上下文
- **DbSet<ThemeConfig>**：已定义主题配置的数据集合
- **AppDbContextFactory**：已修复命名空间错误，实现设计时数据库上下文工厂
- **ThemeConfigRepository**：已完整实现IThemeConfigRepository接口
- **数据库迁移**：已生成InitialCreate迁移文件
- 修复了Date目录名拼写错误，更正为Data

### 6. 主界面
- **Form1**：已完整实现主窗口
- 已实现无边框、置顶、透明背景窗口样式
- 已实现右键菜单（主题切换、退出）
- 已实现渐变背景绘制

### 7. 定时渲染系统
- 已基于PeriodicTimer实现50FPS稳定渲染循环
- 已实现渲染性能优化

### 8. 依赖注入配置
- 已在Program.cs中配置完整的依赖注入系统
- 已实现主题渲染器工厂模式
- 已注册所有核心服务和UI组件
- 已更新Program.cs文件的依赖注入配置注释编号

## 需要实现的功能

### 1. 音频处理完善
- 完善WasapiAudioCapture中的音频数据缓冲区管理
- 实现音频采样率和格式适配

### 2. 数据访问实现
- 实现ThemeConfigRepository类（IThemeConfigRepository的实现）
- 修复Date目录名拼写错误（应为Data）
- 修复AppDbContextFactory的命名空间错误

### 3. 桌面灯带功能扩展
- 支持不同位置（顶部、左侧、右侧）
- 实现高度自适应和DPI缩放
- 支持多显示器环境

### 4. 用户交互优化
- 添加系统托盘图标
- 实现窗口置顶但不拦截鼠标事件
- 开发设置界面

### 5. 配置文件创建
- 更新appsettings.json配置文件，添加AppSettings部分
- 配置应用程序参数（主题ID、帧率、频谱平滑因子等）

### 6. 性能优化
- 优化音频处理性能
- 优化渲染循环效率
- 实现NativeAOT编译配置

### 7. 测试与文档
- 编写单元测试
- 完善API文档
- 准备用户手册

## 关键技术点

### 1. 音频捕获与处理
- 使用NAudio.Wave库的WasapiLoopbackCapture捕获系统输出音频
- 实现音频数据的实时处理和事件通知
- 静音检测算法优化

### 2. FFT频谱分析
- 使用MathNet.Numerics库进行FFT变换
- 实现频谱降采样和峰值检测
- 优化频域数据处理性能

### 3. 图形渲染
- 使用GDI+实现高效的图形渲染
- 实现渐变、透明度等视觉效果
- 优化渲染性能，确保高帧率

### 4. 数据持久化
- 使用Entity Framework Core进行数据访问
- 实现配置的序列化和反序列化
- 支持配置的导入导出

## 后续开发计划

1. **第一阶段**：完善音频捕获和频谱分析功能
2. **第二阶段**：实现主题渲染系统和桌面灯带
3. **第三阶段**：优化用户交互和系统托盘功能
4. **第四阶段**：性能优化和NativeAOT编译配置
5. **第五阶段**：测试、文档完善和发布准备

## 依赖项列表

- .NET 8 SDK
- NAudio（音频捕获库）
- MathNet.Numerics（数学计算库）
- Entity Framework Core（数据访问库）
- Npgsql（PostgreSQL数据库驱动）

## 注意事项

1. 项目采用异步编程模型，注意避免死锁
2. 确保音频处理和UI渲染线程分离
3. 优化内存使用，避免频繁的大对象分配
4. 注意异常处理和资源释放
5. 确保跨DPI和多显示器环境的兼容性